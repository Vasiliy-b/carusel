<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Content Generator</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-row">
                <h1>ğŸ¨ Multi-Agent Content Generator</h1>
                <div class="running-jobs-indicator {% if running_count >= max_concurrent %}at-capacity{% elif running_count > 0 %}active{% endif %}">
                    <span class="jobs-count">{{ running_count }}/{{ max_concurrent }}</span>
                    <span class="jobs-label">{% if running_count >= max_concurrent %}At Capacity{% elif running_count > 0 %}Running{% else %}Ready{% endif %}</span>
                </div>
            </div>
            <div class="header-buttons">
                <button id="generateBtn" class="btn-primary" {% if running_count >= max_concurrent %}disabled{% endif %}>
                    <span>ğŸ“Š Generate from Sheet</span>
                </button>
                <button id="generateTextBtn" class="btn-primary" {% if running_count >= max_concurrent %}disabled{% endif %}>
                    <span>âœ¨ Generate from Text</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Running Jobs Panel -->
        {% if running_jobs %}
        <div class="running-jobs-panel">
            <h3>â³ Running Generations ({{ running_count }}/{{ max_concurrent }})</h3>
            <div class="running-jobs-list">
                {% for job in running_jobs %}
                <div class="running-job-item" data-job-id="{{ job.id }}">
                    <div class="spinner-small"></div>
                    <div class="job-info">
                        <span class="job-mode">{{ job.input_mode|default('sheet', true)|capitalize }}</span>
                        {% if job.text_preview %}
                        <span class="job-preview">{{ job.text_preview }}</span>
                        {% endif %}
                    </div>
                    <span class="job-time">Started {{ job.started_at }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div id="statusBar" class="status-bar hidden">
            <div class="spinner"></div>
            <span id="statusText">ğŸ¤– AI agents are crafting your perfect carousel... This takes 2-3 minutes.</span>
        </div>

        <script>
            // Resume polling for running jobs
            {% if running_jobs %}
            window.addEventListener('DOMContentLoaded', () => {
                {% for job in running_jobs %}
                pollJobStatus("{{ job.id }}");
                {% endfor %}
            });
            {% endif %}
        </script>

        <div id="errorBar" class="error-bar hidden">
            <span id="errorText"></span>
            <button onclick="closeError()">Ã—</button>
        </div>

        <div class="controls-section">
            <div class="style-editor">
                <button id="toggleStyleBtn" class="btn-secondary-sm">âš™ï¸ Customize Image Style</button>
                <div id="stylePanel" class="style-panel hidden">
                    <label for="styleInput">ğŸ¨ Global Style Settings</label>
                    <textarea id="styleInput" rows="3" placeholder="Example: 'pastel colors, soft lighting, elegant, clean style, 3d render, high detail, 3d plasticine'">{{ current_style }}</textarea>
                    <div class="style-actions">
                        <button id="saveStyleBtn" class="btn-primary-sm">ğŸ’¾ Save</button>
                        <button id="resetStyleBtn" class="btn-secondary-sm">ğŸ”„ Reset</button>
                    </div>
                    <p class="style-note">ğŸ’¡ Leave empty when using style reference images. Fill in for consistent style across all generations.</p>
                </div>
            </div>
        </div>

        {% if posts %}
        <div class="post-grid">
            {% for post in posts %}
            <div class="post-card" onclick="window.location.href='/post/{{ post.post_id }}'">
                {% if post.thumbnail %}
                <div class="post-thumbnail">
                    <img src="{{ post.thumbnail }}" alt="{{ post.title }}">
                    <div class="image-count">{{ post.image_count }} images</div>
                </div>
                {% else %}
                <div class="post-thumbnail placeholder">
                    <span>No images</span>
                </div>
                {% endif %}
                
                <div class="post-info">
                    <h3>{{ post.title }}</h3>
                    <p class="post-date">{{ post.date }}</p>
                    <p class="post-id">{{ post.post_id }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>ğŸ¬ Ready to Create Magic?</h3>
            <p>Click one of the generate buttons above to create your first AI-powered Instagram carousel!</p>
        </div>
        {% endif %}
    </main>

    <!-- Text Input Modal -->
    <div id="textInputModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>âœ¨ Generate from Text Input</h2>
            
            <form id="textInputForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="textInput">ğŸ“ Describe your content idea</label>
                    <textarea id="textInput" name="text_input" rows="8" required 
                              placeholder="Example: A romantic story about two people meeting under the stars, told across 10 emotional moments with soft colors and dreamy atmosphere..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="aspectRatio">ğŸ“ Image Aspect Ratio</label>
                    <select id="aspectRatio" name="aspect_ratio" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 14px; background: var(--background);">
                        <option value="1:1">1:1 - Square (1024x1024) - Instagram Standard</option>
                        <option value="4:5">4:5 - Portrait (896x1152) - Instagram Feed</option>
                        <option value="9:16">9:16 - Vertical (768x1344) - Stories/Reels</option>
                        <option value="16:9">16:9 - Landscape (1344x768)</option>
                        <option value="3:4">3:4 - Portrait (864x1184)</option>
                        <option value="4:3">4:3 - Landscape (1184x864)</option>
                    </select>
                    <small>Choose the aspect ratio for all 10 carousel images</small>
                </div>
                
                <div class="form-group">
                    <label for="styleImage">ğŸ¨ Style Reference (optional)</label>
                    <input type="file" id="styleImage" name="style_image" accept="image/png,image/jpeg,image/jpg,image/webp">
                    <small>Upload an image to match its visual style and aesthetic</small>
                </div>
                
                <div class="form-group">
                    <label for="personaImage">ğŸ‘¤ Persona Reference (optional)</label>
                    <input type="file" id="personaImage" name="persona_image" accept="image/png,image/jpeg,image/jpg,image/webp">
                    <small>Upload a person's photo to preserve their facial features</small>
                </div>
                
                <button type="submit" class="btn-primary">ğŸš€ Generate Carousel</button>
            </form>
        </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
    // Modal handling
    const modal = document.getElementById('textInputModal');
    const textBtn = document.getElementById('generateTextBtn');
    const span = document.getElementsByClassName('close')[0];

    textBtn.onclick = function() {
        modal.style.display = 'block';
    }

    span.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // Form submission
    document.getElementById('textInputForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        try {
            const response = await fetch('/generate_from_text', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                modal.style.display = 'none';
                // Show loader and start polling
                showLoader(data.job_id);
                // Update running count indicator
                updateRunningCount(data.running_count, data.max_concurrent);
            } else if (response.status === 429) {
                // At capacity
                alert(`Max concurrent jobs (${data.max_concurrent}) reached. Currently running: ${data.running_count}. Please wait for a job to complete.`);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error starting generation: ' + error);
        }
    });

    // Update running count indicator
    function updateRunningCount(count, max) {
        const indicator = document.querySelector('.running-jobs-indicator');
        const countSpan = indicator.querySelector('.jobs-count');
        const labelSpan = indicator.querySelector('.jobs-label');

        countSpan.textContent = count + '/' + max;

        indicator.classList.remove('at-capacity', 'active');
        if (count >= max) {
            indicator.classList.add('at-capacity');
            labelSpan.textContent = 'At Capacity';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateTextBtn').disabled = true;
        } else if (count > 0) {
            indicator.classList.add('active');
            labelSpan.textContent = 'Running';
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateTextBtn').disabled = false;
        } else {
            labelSpan.textContent = 'Ready';
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateTextBtn').disabled = false;
        }
    }

    // Poll job status (supports multiple concurrent jobs)
    function pollJobStatus(jobId) {
        const interval = setInterval(async () => {
            try {
                const response = await fetch('/status/' + jobId);
                const data = await response.json();

                if (data.status === 'complete' || data.status === 'error') {
                    clearInterval(interval);
                    // Reload page to show updated results and job list
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error polling job', jobId, error);
            }
        }, 3000);
    }
    </script>
</body>
</html>

