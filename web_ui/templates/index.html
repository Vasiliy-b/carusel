<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Content Generator</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ¨ Multi-Agent Content Generator</h1>
            <div>
                <button id="generateBtn" class="btn-primary" {% if active_job_id %}disabled{% endif %}>
                    <span>{% if active_job_id %}â³ Generating...{% else %}ğŸ“Š Generate from Sheet{% endif %}</span>
                </button>
                <button id="generateTextBtn" class="btn-primary" {% if active_job_id %}disabled{% endif %}>
                    <span>âœ¨ Generate from Text</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <div id="statusBar" class="status-bar {% if not active_job_id %}hidden{% endif %}">
            <div class="spinner"></div>
            <span id="statusText">ğŸ¤– AI agents are crafting your perfect carousel... This takes 2-3 minutes. They're perfectionists!</span>
        </div>
        
        <script>
            // Resume polling if there's an active job
            {% if active_job_id %}
            const resumeJobId = "{{ active_job_id }}";
            if (resumeJobId) {
                window.addEventListener('DOMContentLoaded', () => {
                    currentJobId = resumeJobId;
                    pollStatus();
                });
            }
            {% endif %}
        </script>

        <div id="errorBar" class="error-bar hidden">
            <span id="errorText"></span>
            <button onclick="closeError()">Ã—</button>
        </div>

        <div class="controls-section">
            <div class="style-editor">
                <button id="toggleStyleBtn" class="btn-secondary-sm">âš™ï¸ Customize Image Style</button>
                <div id="stylePanel" class="style-panel hidden">
                    <label for="styleInput">ğŸ¨ Global Style Settings</label>
                    <textarea id="styleInput" rows="3" placeholder="Example: 'pastel colors, soft lighting, elegant, clean style, 3d render, high detail, 3d plasticine'">{{ current_style }}</textarea>
                    <div class="style-actions">
                        <button id="saveStyleBtn" class="btn-primary-sm">ğŸ’¾ Save</button>
                        <button id="resetStyleBtn" class="btn-secondary-sm">ğŸ”„ Reset</button>
                    </div>
                    <p class="style-note">ğŸ’¡ Leave empty when using style reference images. Fill in for consistent style across all generations.</p>
                </div>
            </div>
        </div>

        {% if posts %}
        <div class="post-grid">
            {% for post in posts %}
            <div class="post-card" onclick="window.location.href='/post/{{ post.post_id }}'">
                {% if post.thumbnail %}
                <div class="post-thumbnail">
                    <img src="{{ post.thumbnail }}" alt="{{ post.title }}">
                    <div class="image-count">{{ post.image_count }} images</div>
                </div>
                {% else %}
                <div class="post-thumbnail placeholder">
                    <span>No images</span>
                </div>
                {% endif %}
                
                <div class="post-info">
                    <h3>{{ post.title }}</h3>
                    <p class="post-date">{{ post.date }}</p>
                    <p class="post-id">{{ post.post_id }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>ğŸ¬ Ready to Create Magic?</h3>
            <p>Click one of the generate buttons above to create your first AI-powered Instagram carousel!</p>
        </div>
        {% endif %}
    </main>

    <!-- Text Input Modal -->
    <div id="textInputModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>âœ¨ Generate from Text Input</h2>
            
            <form id="textInputForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="textInput">ğŸ“ Describe your content idea</label>
                    <textarea id="textInput" name="text_input" rows="8" required 
                              placeholder="Example: A romantic story about two people meeting under the stars, told across 10 emotional moments with soft colors and dreamy atmosphere..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="aspectRatio">ğŸ“ Image Aspect Ratio</label>
                    <select id="aspectRatio" name="aspect_ratio" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 14px; background: var(--background);">
                        <option value="1:1">1:1 - Square (1024x1024) - Instagram Standard</option>
                        <option value="4:5">4:5 - Portrait (896x1152) - Instagram Feed</option>
                        <option value="9:16">9:16 - Vertical (768x1344) - Stories/Reels</option>
                        <option value="16:9">16:9 - Landscape (1344x768)</option>
                        <option value="3:4">3:4 - Portrait (864x1184)</option>
                        <option value="4:3">4:3 - Landscape (1184x864)</option>
                    </select>
                    <small>Choose the aspect ratio for all 10 carousel images</small>
                </div>
                
                <div class="form-group">
                    <label for="styleImage">ğŸ¨ Style Reference (optional)</label>
                    <input type="file" id="styleImage" name="style_image" accept="image/png,image/jpeg,image/jpg,image/webp">
                    <small>Upload an image to match its visual style and aesthetic</small>
                </div>
                
                <div class="form-group">
                    <label for="personaImage">ğŸ‘¤ Persona Reference (optional)</label>
                    <input type="file" id="personaImage" name="persona_image" accept="image/png,image/jpeg,image/jpg,image/webp">
                    <small>Upload a person's photo to preserve their facial features</small>
                </div>
                
                <button type="submit" class="btn-primary">ğŸš€ Generate Carousel</button>
            </form>
        </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
    // Modal handling
    const modal = document.getElementById('textInputModal');
    const textBtn = document.getElementById('generateTextBtn');
    const span = document.getElementsByClassName('close')[0];

    textBtn.onclick = function() {
        modal.style.display = 'block';
    }

    span.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // Form submission
    document.getElementById('textInputForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/generate_from_text', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok) {
                modal.style.display = 'none';
                // Show loader and start polling
                showLoader(data.job_id);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error starting generation: ' + error);
        }
    });
    </script>
</body>
</html>

